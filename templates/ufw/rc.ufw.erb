#!/bin/sh

for iptables in iptables ip6tables; do
  if ! $iptables -C FORWARD -m physdev --physdev-is-bridged -j ACCEPT; then
    $iptables -I FORWARD -m physdev --physdev-is-bridged -j ACCEPT
  fi
done

ufw --force reset >/dev/null

# short race condition here

ufw enable
<% @allow_in.each do |rule| -%>
ufw allow <%= rule %>
<% end -%>
<% @allow_out.each do |rule| -%>
ufw allow out <%= rule %>
<% end -%>
<% if @reject_out -%>
ufw allow in on lxcbr0 to any
ufw allow out on lxcbr0 to any
ufw reject out proto tcp to any
ufw reject out proto udp to any
<% end -%>

rm -f /{etc,lib}/ufw/*.rules.[0-9]*
